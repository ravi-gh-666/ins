{% extends "base.html" %}
{% block content %}
<div class="container mx-auto max-w-5xl p-6 bg-white rounded-xl shadow mt-8">
    <div class="bg-pink-700 text-white text-center text-4xl font-bold py-8 rounded-t-xl mb-8">
        Compare Health Insurance Policies
    </div>
    <form method="POST" action="/compare" class="mb-8 flex flex-col md:flex-row gap-6 items-end" autocomplete="off">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="flex-1">
            <h2 class="text-xl font-semibold mb-2">Policy 1</h2>
            <label for="insurer1" class="block text-base font-medium mb-1">Select Insurer:</label>
            <select name="insurer1" id="insurer1" required class="w-full rounded border border-gray-300 px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
                {% for insurer in insurers %}
                    <option value="{{ insurer.id }}" {% if request.form.insurer1|default('')|string == insurer.id|string %}selected{% endif %}>{{ insurer.name }}</option>
                {% endfor %}
            </select>
            <label for="policy1" class="block text-base font-medium mb-1">Select Policy:</label>
            <select name="policy1" id="policy1" required class="w-full rounded border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-600">
                <!-- Policies for insurer 1 will be loaded dynamically -->
            </select>
        </div>
        <div class="flex-1">
            <h2 class="text-xl font-semibold mb-2">Policy 2</h2>
            <label for="insurer2" class="block text-base font-medium mb-1">Select Insurer:</label>
            <select name="insurer2" id="insurer2" required class="w-full rounded border border-gray-300 px-3 py-2 mb-3 focus:outline-none focus:ring-2 focus:ring-pink-600">
                {% for insurer in insurers %}
                    <option value="{{ insurer.id }}" {% if request.form.insurer2|default('')|string == insurer.id|string %}selected{% endif %}>{{ insurer.name }}</option>
                {% endfor %}
            </select>
            <label for="policy2" class="block text-base font-medium mb-1">Select Policy:</label>
            <select name="policy2" id="policy2" required class="w-full rounded border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-600">
                <!-- Policies for insurer 2 will be loaded dynamically -->
            </select>
        </div>
        <div class="flex-basis-full text-center mt-6">
            <button type="submit" class="bg-pink-700 text-white font-semibold py-3 px-8 rounded-lg hover:bg-pink-800 transition">Compare</button>
        </div>
    </form>
    <div class="mt-8">
        <h2 class="text-lg font-semibold mb-4">Popular Policy Comparisons</h2>
        <div class="flex flex-wrap gap-6">
            {% for left, right in popular_comparisons %}
            <form method="POST" action="/compare" class="popular-compare-form flex-1 min-w-[300px] max-w-[400px] flex flex-col items-center bg-white rounded-xl shadow p-6 mb-4 cursor-pointer border-2 border-transparent transition hover:shadow-lg hover:border-pink-700" tabindex="0">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="insurer1" value="{{ left['insurer_id'] if left['insurer_id'] is defined else '' }}">
                <input type="hidden" name="policy1" value="{{ left['id'] }}">
                <input type="hidden" name="insurer2" value="{{ right['insurer_id'] if right['insurer_id'] is defined else '' }}">
                <input type="hidden" name="policy2" value="{{ right['id'] }}">
                <div class="flex items-center justify-center w-full gap-6 mb-2">
                    <div class="text-center">
                        <div class="mb-1">{{ score_ring(left['overall_score']) }}</div>
                        <div class="font-semibold">{{ left['insurer'] }}<br>{{ left['name'] }}</div>
                    </div>
                    <div class="text-2xl text-gray-400 font-bold">vs</div>
                    <div class="text-center">
                        <div class="mb-1">{{ score_ring(right['overall_score']) }}</div>
                        <div class="font-semibold">{{ right['insurer'] }}<br>{{ right['name'] }}</div>
                    </div>
                </div>
                <div class="w-full text-center text-base text-gray-600 border-t border-gray-200 pt-2 mb-2">
                    {{ left['insurer'] }} {{ left['name'] }} <span class="bg-gray-100 text-gray-500 rounded-full px-3 py-1 mx-2">vs</span> {{ right['insurer'] }} {{ right['name'] }}
                </div>
            </form>
            {% endfor %}
        </div>
    </div>
    {% if policy1 and policy2 %}
    {% set summary = None %}
    {% for row in db.execute('SELECT report FROM compare_reports WHERE policy1_id=? AND policy2_id=?', (policy1['id'], policy2['id'])) %}
        {% set summary = row[0] %}
    {% endfor %}
    {% if not summary %}
        {% for row in db.execute('SELECT report FROM compare_reports WHERE policy1_id=? AND policy2_id=?', (policy2['id'], policy1['id'])) %}
            {% set summary = row[0] %}
        {% endfor %}
    {% endif %}
    {% if summary %}
    <div class="prose max-w-none my-8 p-6 bg-yellow-50 border-l-4 border-yellow-400 rounded">
        <h2 class="text-2xl font-bold mb-4 text-yellow-800">Comparison Summary</h2>
        {{ summary|safe }}
    </div>
    {% endif %}
    {% if compare_summary %}
    <div class="prose max-w-none my-8 p-6 bg-yellow-50 border-l-4 border-yellow-400 rounded">
        <h2 class="text-2xl font-bold mb-4 text-yellow-800">Comparison Summary</h2>
        {{ compare_summary|safe }}
    </div>
    {% endif %}
    <div id="compare-result" class="mt-12">
      <h2 class="text-2xl font-bold text-center mb-6">Policy Comparison</h2>
      <table class="min-w-full border border-gray-200 rounded-lg shadow text-base">
        <thead>
          <tr class="bg-gray-100">
            <th class="p-4 text-left">Feature</th>
            <th class="p-4 text-center">
              <div class="text-lg font-bold">{{ policy1['name'] }}</div>
              <div class="text-base text-gray-600">{{ policy1['insurer'] }}</div>
            </th>
            <th class="p-4 text-center">
              <div class="text-lg font-bold">{{ policy2['name'] }}</div>
              <div class="text-base text-gray-600">{{ policy2['insurer'] }}</div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr class="bg-gray-50">
            <td class="font-semibold">Overall Score</td>
            <td class="text-center">{{ score_ring(policy1['overall_score']) }}</td>
            <td class="text-center">{{ score_ring(policy2['overall_score']) }}</td>
          </tr>
          <tr>
            <td class="font-semibold">Insurer Rating</td>
            <td class="text-center">{{ score_ring(policy1['insurer_rating']) }}</td>
            <td class="text-center">{{ score_ring(policy2['insurer_rating']) }}</td>
          </tr>
          <tr class="bg-gray-50">
            <td class="font-semibold">Feature Rating</td>
            <td class="text-center">{{ score_ring(policy1['feature_rating']) }}</td>
            <td class="text-center">{{ score_ring(policy2['feature_rating']) }}</td>
          </tr>
          <tr>
            <td class="font-semibold">Affordability</td>
            <td class="text-center">{{ score_ring(policy1['affordability_rating']) }}</td>
            <td class="text-center">{{ score_ring(policy2['affordability_rating']) }}</td>
          </tr>
          {% for feature in all_features %}
          {% set v1 = features1[feature] if features1 and feature in features1 else None %}
          {% set v2 = features2[feature] if features2 and feature in features2 else None %}
          {% set highlight = (v1 != v2 and (v1 in ['Yes','No','yes','no'] or v2 in ['Yes','No','yes','no'])) %}
          <tr class="{{ loop.index0 % 2 == 0 and 'bg-gray-50' or '' }} align-top">
            <td class="min-w-[220px] max-w-[320px] p-4">
              <div class="font-semibold flex items-center gap-2">
                {{ feature }}
                {% set f1 = (features1_full[feature] if features1_full and feature in features1_full else None) %}
                {% set f2 = (features2_full[feature] if features2_full and feature in features2_full else None) %}
                {% set yt = f1.youtube_video if f1 and f1.youtube_video else (f2.youtube_video if f2 and f2.youtube_video else None) %}
                {% if yt %}
                <a href="{{ yt }}" target="_blank" title="Watch feature explanation on YouTube" class="inline-block align-middle">
                  <img src="https://www.svgrepo.com/show/13671/youtube.svg" alt="YouTube" class="w-6 h-6 ml-1 drop-shadow" />
                </a>
                {% endif %}
              </div>
            </td>
            <td class="text-center min-w-[120px] max-w-[220px] p-4">
              {% if v1 is not none %}
                <span class="compare-highlight {% if highlight %}bg-pink-100 text-pink-800 font-semibold rounded px-3 py-1{% endif %}">{{ v1 }}</span>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>
            <td class="text-center min-w-[120px] max-w-[220px] p-4">
              {% if v2 is not none %}
                <span class="compare-highlight {% if highlight %}bg-pink-100 text-pink-800 font-semibold rounded px-3 py-1{% endif %}">{{ v2 }}</span>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <script>
    document.getElementById('compare-result').scrollIntoView({ behavior: 'smooth' });
    </script>
    {% endif %}
</div>
<script>
function loadPolicies(insurerSelectId, policySelectId, selectedPolicyId) {
    const insurerId = document.getElementById(insurerSelectId).value;
    fetch(`/api/policies/${insurerId}`)
        .then(response => response.json())
        .then(policies => {
            const policySelect = document.getElementById(policySelectId);
            policySelect.innerHTML = "";
            policies.forEach(p => {
                const opt = document.createElement("option");
                opt.value = p.id;
                opt.textContent = p.name;
                if (selectedPolicyId && selectedPolicyId == p.id) {
                    opt.selected = true;
                }
                policySelect.appendChild(opt);
            });
        });
}
function checkCompareBtn() {
    const p1 = document.getElementById('policy1').value;
    const p2 = document.getElementById('policy2').value;
    document.querySelector('button[type="submit"]').disabled = !(p1 && p2);
}
window.addEventListener("DOMContentLoaded", function() {
    const selectedInsurer1 = "{{ request.form.insurer1|default('') }}";
    const selectedPolicy1 = "{{ request.form.policy1|default('') }}";
    const selectedInsurer2 = "{{ request.form.insurer2|default('') }}";
    const selectedPolicy2 = "{{ request.form.policy2|default('') }}";
    if (selectedInsurer1) document.getElementById('insurer1').value = selectedInsurer1;
    if (selectedInsurer2) document.getElementById('insurer2').value = selectedInsurer2;
    loadPolicies("insurer1", "policy1", selectedPolicy1);
    loadPolicies("insurer2", "policy2", selectedPolicy2);
    document.getElementById("insurer1").addEventListener("change", function() {
        loadPolicies("insurer1", "policy1");
        setTimeout(checkCompareBtn, 100);
    });
    document.getElementById("insurer2").addEventListener("change", function() {
        loadPolicies("insurer2", "policy2");
        setTimeout(checkCompareBtn, 100);
    });
    document.getElementById("policy1").addEventListener("change", checkCompareBtn);
    document.getElementById("policy2").addEventListener("change", checkCompareBtn);
    setTimeout(checkCompareBtn, 200);
    document.querySelectorAll('.popular-compare-form').forEach(function(form) {
        form.addEventListener('click', function() {
            form.submit();
        });
        form.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                form.submit();
            }
        });
    });
});
</script>
{% endblock %}
